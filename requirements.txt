import streamlit as st
import pandas as pd
import networkx as nx
import io

# 1. æ ¸å¿ƒé‚è¼¯ï¼šè¨ˆç®—ç§»å‹•é †åº
def generate_optimized_move_plan(df_ref, df_new):
    # æå–é—œéµè³‡è¨Š
    def get_slot_map(df):
        # å»ºç«‹ Machine-Slot å”¯ä¸€éµå€¼
        df['SlotID'] = df['æ©Ÿå°è™Ÿ'].astype(str) + "-" + df['æ–™ç«™'].astype(str)
        return dict(zip(df['SlotID'], df['å­ä»¶æ–™è™Ÿ'])), df[['SlotID', 'å­ä»¶æ–™è™Ÿ', 'æ©Ÿå°è™Ÿ', 'æ–™ç«™']]

    ref_map, ref_info = get_slot_map(df_ref.copy())
    new_map, new_info = get_slot_map(df_new.copy())

    # æ‰¾å‡ºæ‰€æœ‰æ–™è™Ÿçš„è®Šå‹•
    moves_needed = []
    
    # ä»¥ã€Œå­ä»¶æ–™è™Ÿã€ç‚ºåŸºæº–æ‰¾ä½ç½®è®ŠåŒ–
    # æ³¨æ„ï¼šé€™è£¡è™•ç†ä¸€å°ä¸€åŒ¹é…ï¼Œè‹¥åŒä¸€æ–™è™Ÿæœ‰å¤šç«™ï¼Œå‰‡ä¾æ–™ç«™é †åºåŒ¹é…
    ref_parts = ref_info.values.tolist() # [SlotID, Part, Machine, Slot]
    new_parts = new_info.values.tolist()

    # å»ºç«‹ç›®æ¨™ä½ç½®åœ°åœ–
    target_positions = {} # Part -> [TargetSlotIDs]
    for s, p, m, sl in new_parts:
        target_positions.setdefault(p, []).append(s)

    # æ¯”å°å“ªäº›éœ€è¦ç§»å‹•
    pending_moves = []
    current_slots = ref_map.copy()

    for s_old, p_old, m_old, sl_old in ref_parts:
        if p_old in target_positions and s_old in target_positions[p_old]:
            # ä½ç½®æ²’è®Šï¼Œå¾ç›®æ¨™æ¸…å–®ç§»é™¤ï¼Œä¸éœ€ç§»å‹•
            target_positions[p_old].remove(s_old)
        else:
            # éœ€è¦ç§»èµ°æˆ–ç§»é™¤
            pending_moves.append({'Part': p_old, 'From': s_old, 'Machine': m_old, 'Slot': sl_old})

    # æœ€çµ‚ç§»å‹•æŒ‡ä»¤é›†
    final_plan = []
    
    # æ­¥é©Ÿ A: è™•ç†ç§»é™¤ (ç›®æ¨™è¡¨è£¡æ²’æœ‰çš„æ–™è™Ÿï¼Œå…ˆæ¸…ç©ºç«™ä½)
    for m in list(pending_moves):
        p = m['Part']
        if p not in target_positions or not target_positions[p]:
            final_plan.append({
                'æ©Ÿå°': m['Machine'], 'å­ä»¶æ–™è™Ÿ': p, 'åŸå§‹ç«™ä½': m['Slot'], 
                'ç›®æ¨™ç«™ä½': 'ä¸‹æ–™/ç§»é™¤', 'å‹•ä½œ': 'ç§»é™¤'
            })
            if m['From'] in current_slots: del current_slots[m['From']]
            pending_moves.remove(m)

    # æ­¥é©Ÿ B: è™•ç†ç§»å‹• (ç›®æ¨™è¡¨è£¡æœ‰çš„æ–™è™Ÿï¼Œéœ€è€ƒæ…®ç«™ä½è¡çª)
    # é‚è¼¯ï¼šåªæœ‰ç•¶ã€Œç›®æ¨™ç«™ä½ã€ç›®å‰æ˜¯ç©ºçš„æ™‚å€™ï¼Œæ‰èƒ½ç§»å…¥
    moves_to_process = []
    for m in pending_moves:
        if m['Part'] in target_positions and target_positions[m['Part']]:
            dest_slot = target_positions[m['Part']].pop(0)
            moves_to_process.append({'Part': m['Part'], 'From': m['From'], 'To': dest_slot, 'Machine': m['Machine'], 'Slot': m['Slot']})

    changed = True
    while moves_to_process and changed:
        changed = False
        for m in list(moves_to_process):
            if m['To'] not in current_slots: # ç›®æ¨™ç«™ä½æ˜¯ç©ºçš„
                final_plan.append({
                    'æ©Ÿå°': m['Machine'], 'å­ä»¶æ–™è™Ÿ': m['Part'], 'åŸå§‹ç«™ä½': m['Slot'], 
                    'ç›®æ¨™ç«™ä½': m['To'].split('-')[1], 'å‹•ä½œ': 'ç§»å‹•'
                })
                if m['From'] in current_slots: del current_slots[m['From']]
                current_slots[m['To']] = m['Part']
                moves_to_process.remove(m)
                changed = True
        
        # è™•ç†ç’°å½¢è¡çª (A->B, B->A)ï¼šè‹¥å¡æ­»ï¼Œå¼·è¿«å°‡ä¸€å€‹æ–™æ¶ç§»å¾€ TEMP
        if not changed and moves_to_process:
            m = moves_to_process[0]
            final_plan.append({
                'æ©Ÿå°': m['Machine'], 'å­ä»¶æ–™è™Ÿ': m['Part'], 'åŸå§‹ç«™ä½': m['Slot'], 
                'ç›®æ¨™ç«™ä½': 'TEMPæš«å­˜å€', 'å‹•ä½œ': 'æš«å­˜'
            })
            if m['From'] in current_slots: del current_slots[m['From']]
            m['From'] = 'TEMP' # æ›´æ–°ä¾†æºåœ°ç‚ºæš«å­˜å€
            changed = True

    # æ­¥é©Ÿ C: è™•ç†æ–°å¢ (æ–°è¡¨æœ‰ï¼ŒèˆŠè¡¨æ²’æœ‰çš„)
    for p, slots in target_positions.items():
        for s in slots:
            final_plan.append({
                'æ©Ÿå°': s.split('-')[0], 'å­ä»¶æ–™è™Ÿ': p, 'åŸå§‹ç«™ä½': 'æ–°æ–™æ¶', 
                'ç›®æ¨™ç«™ä½': s.split('-')[1], 'å‹•ä½œ': 'æ–°å¢'
            })

    return pd.DataFrame(final_plan)

# --- Streamlit UI ä»‹é¢ ---
st.set_page_config(page_title="Yamaha SMT æ›ç·šå„ªåŒ–å·¥å…·", layout="wide")
st.title("ğŸ› ï¸ Yamaha SMT ç«™ä½è®Šæ›´é †åºè¡¨ç”Ÿæˆå™¨")
st.markdown("é‡å° Yamaha P-Tool å°å‡ºçš„ Excel é€²è¡Œæ¯”å°ï¼Œè‡ªå‹•è¦åŠƒæœ€çœæ™‚ä¸”ä¸è¡çªçš„ç§»å‹•é †åºã€‚")

col1, col2 = st.columns(2)

with col1:
    st.subheader("1. è¨­å®šåƒè€ƒç«™ä½ (åŸå§‹ç‹€æ…‹)")
    ref_file = st.file_uploader("ä¸Šå‚³åƒè€ƒç«™ Excel", type=['xlsx', 'csv'], key="ref")

with col2:
    st.subheader("2. è¨­å®šç›®æ¨™ç«™ä½ (æ–°ç‹€æ…‹)")
    new_files = st.file_uploader("ä¸Šå‚³ä¸€æˆ–å¤šå€‹ç›®æ¨™æ–™è¡¨", type=['xlsx', 'csv'], accept_multiple_files=True, key="new")

if ref_file and new_files:
    # è®€å–åƒè€ƒæª”
    df_ref = pd.read_excel(ref_file) if ref_file.name.endswith('xlsx') else pd.read_csv(ref_file)
    
    for uploaded_file in new_files:
        st.divider()
        st.write(f"### ğŸ“‹ åˆ†ææª”æ¡ˆï¼š{uploaded_file.name}")
        
        df_new = pd.read_excel(uploaded_file) if uploaded_file.name.endswith('xlsx') else pd.read_csv(uploaded_file)
        
        try:
            # åŸ·è¡Œé‹ç®—
            result_df = generate_optimized_move_plan(df_ref, df_new)
            result_df.insert(0, 'é †åº', range(1, len(result_df) + 1))
            
            # é¡¯ç¤ºçµæœ
            st.dataframe(result_df, use_container_width=True)
            
            # æä¾›ä¸‹è¼‰
            output = io.BytesIO()
            with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
                result_df.to_excel(writer, index=False, sheet_name='ç§»å‹•é †åºè¡¨')
            
            st.download_button(
                label=f"ğŸ“¥ ä¸‹è¼‰ {uploaded_file.name} ç§»å‹•é †åºè¡¨",
                data=output.getvalue(),
                file_name=f"Move_Plan_{uploaded_file.name}.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            )
        except Exception as e:
            st.error(f"åˆ†æå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬„ä½æ ¼å¼æ˜¯å¦æ­£ç¢º (éœ€åŒ…å«: æ©Ÿå°è™Ÿ, æ–™ç«™, å­ä»¶æ–™è™Ÿ)ã€‚éŒ¯èª¤åŸå› : {e}")